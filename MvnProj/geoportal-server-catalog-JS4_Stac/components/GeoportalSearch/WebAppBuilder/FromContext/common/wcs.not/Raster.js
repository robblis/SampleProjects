define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/config","dojo/json","dojo/sniff","esri/kernel","esri/Evented","esri/request","esri/geometry/Extent","esri/SpatialReference","esri/deferredUtils","esri/layers/PixelBlock","esri/layers/rasterFormats/LercCodec"],function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){var g,nt,k,tt,it=t(h,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:["U1","U2","U4","U8","U16","U32","S8","S16","S32","F32"],validFormats:["lerc","jpeg","jpg","jpgpng","png","png8","png24","png32","bip","bsq","tiff"],_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(n){this.imageServiceUrl=n;this.registerConnectEvents();this._loadRasterFormatModules()},read:function(n,t,f){var h=this,s=new r(v._dfdCanceller),e,l,y,a;if(o("ie")<10)throw"This browser is not supported.";if(!n.imageServiceParameters)throw"Insufficient parameters to read data";return e=i.clone(n.imageServiceParameters),l=n.pixelType,u.some(this.validPixelTypes,function(n){return n===l})||(e.pixelType="F32"),u.some(this.validFormats,function(n){return n.toLowerCase()===e.format.toLowerCase()})||(e.format="lerc"),y=n.decodeFunc,this._prepareGetImageParameters(e),s._pendingDfd=c({url:this.imageServiceUrl+"/exportImage",handleAs:"arraybuffer",content:i.mixin(e,{f:"image"}),load:function(n){var i={width:e.width,height:e.height,planes:null,pixelType:l,noDataValue:e.noData,format:e.format},r=h.decode(n,i);r.then(function(n){a={pixelBlock:n,extent:e.extent};h._resolve([a,e],"onRasterReadComplete",t,s)},function(n){h._resolve([n],null,f,s,!0)})},error:function(n){h._resolve([n],null,f,s,!0)}}),s.promise},decode:function(n,t){var i,r,u;if(t===undefined||t===null)throw"missing decode options";return t.format&&(i=t.format.toUpperCase()),i!=="BSQ"&&i!=="BIP"&&(i=this._getFormat(n)),r=t.decodeFunc,(r===undefined||r===null)&&(r=this._getFormatDecoderDfd(i)),r(n,t)},onRasterReadComplete:function(){},_prepareGetImageParameters:function(n){var u,r,t,f;if(n.size&&n.bbox){u=n.size.split(",");n.width=parseFloat(u[0]);n.height=parseFloat(u[1]);n.extent||(r=n.bbox.split(","),n.extent=new l(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3]),new a(n.bboxSR)));return}if(!n.width||Math.floor(n.width)!==n.width||!n.height||Math.floor(n.height)!==n.height)throw"Incorrect Image Dimensions";if(!n.extent||n.extent.declaredClass!=="esri.geometry.Extent")throw"Incorrect extent";t=n.extent;f=t.spatialReference.wkid||e.toJson(t.spatialReference.toJson());delete n._ts;i.mixin(n,{bbox:t.xmin+","+t.ymin+","+t.xmax+","+t.ymax,imageSR:f,bboxSR:f,size:n.width+","+n.height},n.disableClientCaching?{_ts:(new Date).getTime()}:{})},_adjustExtent:function(n,t,i){var r=n.ymax-n.ymin,u=n.xmax-n.xmin;return i>=t?(r=u*t/i,n.ymax=n.ymin+r):(u=r*i/t,n.xmax=n.xmin+u),n},_resolve:function(n,t,i,r,u){t&&this[t].apply(this,n);i&&i.apply(null,n);r&&v._resDfd(r,n,u)},_getFormatDecoderDfd:function(n){var t=null;switch(n){case"LERC":t=this._decodeLerc;break;case"JPEG":t=this._decodeJpeg;break;case"PNG":t=this._decodePng;break;case"BSQ":t=this._decodeBsq;break;case"BIP":t=this._decodeBip;break;case"TIFF":t=this._decodeTiff;break;default:t=function(){throw"The format is not supported";}}return t=i.hitch(this,t),function(n,i){var u=new r,f;try{f=t(n,i);u.resolve(f)}catch(e){u.reject(e)}return u}},_getFormat:function(n){var t=new Uint8Array(n,0,10),i="";return t[0]===255&&t[1]===216?i="JPEG":t[0]===137&&t[1]===80&&t[2]===78&&t[3]===71?i="PNG":t[0]===67&&t[1]===110&&t[2]===116&&t[3]===90&&t[4]===73&&t[5]===109&&t[6]===97&&t[7]===103&&t[8]===101&&t[9]===32?i="LERC":t[0]===76&&t[1]===101&&t[2]===114&&t[3]===99&&t[4]===50&&t[5]===32?i="LERC2":t[0]===73&&t[1]===73&&t[2]===42&&t[3]===0||t[0]===77&&t[1]===77&&t[2]===0&&t[3]===42?i="TIFF":String.fromCharCode.apply(null,t).toLowerCase().indexOf("error")>-1&&(i="ERROR"),i},_validateDecodeParams:function(n){if(!n.height||Math.floor(n.height)!==n.height)throw"Height not provided.";if(!n.width||Math.floor(n.width)!==n.width)throw"Width not provided.";},_decodeJpeg:function(n,t){var f,i,u,r,e;if(!g)throw"The jpeg decoder module is not loaded.";if(this._validateDecodeParams(t),f=new g,i=f.decode(n),!rt(i,t))throw"The decoded image dimensions are incorrect.";for(u=[],r=0;r<i.pixels.length;r++)e=i.pixels[r],u.push(this._calculateBandStatistics(e));return new y({width:i.width,height:i.height,pixels:i.pixels,pixelType:"U8",mask:i.mask,statistics:u})},_decodePng:function(n,t){var e;if(!nt)throw"The png decoder module is not loaded.";this._validateDecodeParams(t);var h=new Uint8Array(n),o=new nt(h),f=new Uint8Array(t.width*t.height*4);o.copyToImageData(f,o.decodePixels());for(var i=0,r=0,u,s=new Uint8Array(t.width*t.height),i=0;i<t.width*t.height;i++)s[i]=f[i*4+3];for(e=new y({width:t.width,height:t.height,pixels:[],pixelType:"U8",mask:s,statistics:[]}),i=0;i<3;i++){for(u=new Uint8Array(t.width*t.height),r=0;r<t.width*t.height;r++)u[r]=f[r*4+i];e.addData({pixels:u,statistics:this._calculateBandStatistics(u)})}return e},_decodeBsq:function(n,t){if(!k)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(t);w=t.noDataValue;t.pixelType=d(t.pixelType);for(var i=k.decodeBSQ(n,{bandCount:t.planes,width:t.width,height:t.height,pixelType:b,noDataValue:w}),u=[],f=null,r=0;r<i.pixels.length;r++)f=i.pixels[r],u.push(this._calculateBandStatistics(f));return new y({width:t.width,height:t.height,pixels:i.pixels,pixelType:t.pixelType,mask:i.maskData,statistics:u})},_decodeBip:function(n,t){this._validateDecodeParams(t);w=t.noDataValue;t.pixelType=d(t.pixelType);for(var i=k.decodeBIP(n,{bandCount:t.planes,width:t.width,height:t.height,pixelType:b,noDataValue:w}),u=[],f=null,r=0;r<i.pixels.length;r++)f=i.pixels[r],u.push(this._calculateBandStatistics(f));return new y({width:t.width,height:t.height,pixels:i.pixels,pixelType:t.pixelType,mask:i.maskData,statistics:u})},_decodeTiff:function(n,t){this._validateDecodeParams(t);w=t.noDataValue;t.pixelType=d(t.pixelType);for(var i=tt.decode(n),u=[],f=null,r=0;r<i.pixels.length;r++)f=i.pixels[r],u.push(this._calculateBandStatistics(f));return new y({width:t.width,height:t.height,pixels:i.pixels,pixelType:t.pixelType,mask:i.maskData,statistics:u})},_decodeLerc:function(n,t){var i;this._validateDecodeParams(t);w=t.noDataValue;t.pixelType=d(t.pixelType);for(var r=0,e,u=0,f,o=n.byteLength-10;u<o;){if(i=p.decode(n,{inputOffset:u,encodedMaskData:e,returnMask:r===0?!0:!1,returnEncodedMask:r===0?!0:!1,returnFileInfo:!0,pixelType:b,noDataValue:w}),u=i.fileInfo.eofOffset,r===0&&(e=i.encodedMaskData,f=new y({width:t.width,height:t.height,pixels:[],pixelType:t.pixelType,mask:i.maskData,statistics:[]})),r++,!rt(i,t))throw"The decoded image dimensions are incorrect";f.addData({pixels:i.pixelData,statistics:{minValue:i.minValue,maxValue:i.maxValue,noDataValue:i.noDataValue}})}return f},_calculateBandStatistics:function(n){for(var i=Infinity,r=-Infinity,f=n.length,t=0,u=0;u<f;u++)t=n[u],i=t<i?t:i,r=t>r?t:r;return{minValue:i,maxValue:r}},_loadRasterFormatModules:function(){o("ie")<10||n(["esri/layers/rasterFormats/JpgPlus","esri/layers/rasterFormats/Png","esri/layers/rasterFormats/Raw","./Tiff"],function(n,t,i,r){g=n;nt=t;k=i;tt=r})}}),b=null,w=null,d=function(n){return n==="U1"||n==="U2"||n==="U4"||n==="U8"?(n="U8",w=Math.pow(2,8)-1,b=Uint8Array,n):n==="U16"?(w=w||Math.pow(2,16)-1,b=Uint16Array,n):n==="U32"?(w=w||Math.pow(2,32)-1,b=Uint32Array,n):n==="S8"?(w=w||0-Math.pow(2,7),b=Int8Array,n):n==="S16"?(w=w||0-Math.pow(2,15),b=Int16Array,n):n==="S32"?(w=w||0-Math.pow(2,31),b=Int32Array,n):(b=Float32Array,n)},rt=function(n,t){return n.height!==t.height||n.width!==t.width?!1:!0};return o("extend-esri")&&i.setObject("layers.Raster",it,s),it});
//# sourceMappingURL=Raster.min.js.map
